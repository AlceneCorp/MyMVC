{% extends 'base.twig' %}

{% block content %}
<div class="container-fluid mt-5">
    <div class="row">
        {% include 'admin/include/adminMenu.twig' %}
        <!-- Main Content -->
        <main class="col-md-12 ms-sm-auto col-lg-10 px-md-4">
            <!-- Header Section -->
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2"><i class="fas fa-poll me-2"></i> Création de questionnaires</h1>
            </div>

            <div class="rounded p-4 bg-white shadow-lg">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="p-4 border rounded bg-light shadow-sm">
                            <form id="quizChange" method="post" class="mb-4">
                                <legend class="fw-bold text-secondary mb-3">
                                    <i class="fas fa-tasks pt-3 pb-2 mb-3 border-bottom"></i> Actions Questionnaire
                                </legend>
                                <input type="text" class="form-control" name="QUIZ_ID" value="{{ verif('QUIZ_ID') }}" hidden>
                                <select class="form-select" name="QUIZ_ID" onChange="this.form.submit();" hidden>
                                    <option value="0" {% if not verif('QUIZ_ID') %}selected{% endif %}>
                                        Sélectionnez un questionnaire
                                    </option>
                                    {% for qui in quiz %}
                                    <option value="{{ qui.ID }}" {% if verif('QUIZ_ID') == qui.ID %}selected{% endif %}>
                                        {{ decrypt(qui.TEXT) }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </form>
                            <button class="btn btn-success w-100 mb-3" type="button" id="NEW_QUIZ">
                                <i class="fas fa-plus me-2"></i>Nouveau questionnaire
                            </button>
                            {% for qui in quiz %}
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <span id="QUIZNAME_{{ qui.ID }}" class="fw-bold text-secondary me-3">
                                    {{ decrypt(qui.TEXT) }}
                                </span>
                                <div class="d-flex gap-2">
                                    <button name="QUIZEDIT_{{ qui.ID }}" class="btn btn-warning btn-sm btn-edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button name="QUIZDELETE_{{ qui.ID }}" class="btn btn-danger btn-sm btn-delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="p-4 border rounded bg-light shadow-sm">
                            <legend class="fw-bold text-secondary mb-3">
                                {% if verif("QUIZ_ID") > 0 %}
                                    <i class="fas fa-file-edit pt-3 pb-2 mb-3 border-bottom"></i> Éditer Questionnaire
                                {% else %}
                                    <i class="fas fa-file-alt pt-3 pb-2 mb-3 border-bottom"></i> Création Questionnaire
                                {% endif %}
                            </legend>
                            <form id="formQuizCrea" method="post">
                                <input type="text" class="form-control mb-3" name="QUIZ_ID" value="{{ verif('QUIZ_ID') }}" hidden />

                                <input type="text" class="form-control mb-3" name="QUIZ_TEXT" placeholder="Nom du questionnaire" value="{{ verif('QUIZ_ID') ? decrypt(quiz_edit.TEXT) : '' }}" />

                                <textarea class="form-control mb-3" name="QUIZ_DESC" placeholder="Description du questionnaire" rows="5">{{ verif('QUIZ_ID') ? decrypt(quiz_edit.DESC) : '' }}</textarea>

                                <label class="fw-bold mb-2 text-secondary">Date de début et de fin</label>
                                <div class="input-group mb-3">
                                    <input type="datetime-local" class="form-control"
                                        name="QUIZ_START" value="{{ verif('QUIZ_ID') ? quiz_edit.START|date('Y-m-d\\TH:i') : 'now'|date('Y-m-d\\TH:i') }}" />
                                    <span class="input-group-text">à</span>
                                    <input type="datetime-local" class="form-control" name="QUIZ_END" value="{{ verif('QUIZ_ID') ? quiz_edit.END|date('Y-m-d\\TH:i') : 'now'|date('Y-m-d\\TH:i') }}" />
                                </div>

                                <label for="QUIZLOGO" class="fw-bold text-secondary">Logo du questionnaire</label>
                                <input type="text" class="form-control mb-3" id="QUIZLOGO" name="QUIZ_LOGO"
                                    value="{{ verif('QUIZ_ID') ? decrypt(quiz_edit.LOGO) : '' }}">

                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-success px-4" type="submit">
                                        <i class="fas fa-save me-2"></i>Sauvegarder
                                    </button>
                                    {% if verif('QUIZ_ID') %}
                                    <button type="button" class="btn btn-primary px-4" id="btnCategories">
                                        Aller aux catégories <i class="fas fa-chevron-right ms-2"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </form>

                            <!-- Formulaire caché pour les données -->
				            <form id="formCategories" method="post" action="{{base_url}}/admin/categories/">
					            <input type="hidden" name="QUIZ_ID" value="{{ verif('QUIZ_ID') }}">
					            <!-- Ajoutez d'autres champs ici si nécessaire -->
				            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}


{% block jquery %}
<script src="https://cdn.jsdelivr.net/npm/jquery.scrollto@2.1.3/jquery.scrollTo.min.js"></script>

<script>
    $(function() 
	{
		$("#NEW_QUIZ").click(function()
		{
			//$("select[name='QUIZ_ID']").val(0).trigger('change');
		});
	
		// Action lorsque le bouton "Aller aux catégories" est cliqué
		$('#btnCategories').click(function() 
		{
			// Remplir le formulaire caché avec les données du formulaire principal
			$('#formCategories').submit();
		});
	
	
		$(".btn-edit, .btn-save, .btn-delete").click(function() 
		{
			var_cat = $(this).attr('name').split("_")[0];
			var_id = $(this).attr('name').split("_")[1];
		
			console.log($(this).attr("name"));
			console.log($(this).attr('name').split("_")[1]);
			switch(var_cat)
			{
				//Questionnaire
				case "QUIZEDIT":
					$("select[name='QUIZ_ID']").val(var_id).trigger('change');
					break;
				
				case "QUIZDELETE":
					console.log(var_id);
					if (confirm('Voullez-vous vraiment supprimer le quiz : ( ' + $("#QUIZNAME_" + var_id).html() + " ) ?")) 
					{
					  $.ajax
						(
							{
								dataType: "JSON",
								method:"POST",
								url:"{{base_url}}/questorium/ajax/quizdel/" + var_id,
								data:{"QUIZ_DEL" : var_id},
								success: function(data) 
								{
								
								},
								complete: function() 
								{
									window.location.reload()
								},
								error: function() 
								{
								
								}
							}
						);
					}
					break;
			}
		});
	
		$("#formQuizCrea").submit(function(event) 
		{
			event.preventDefault();
			$.ajax
			(
				{
					dataType: "JSON",
					method:"POST",
					url:"{{base_url}}/questorium/ajax/quiz",
					data:$("#formQuizCrea").serialize(),
					success: function(data) 
					{
					
					},
					complete: function() 
					{
						window.location.reload()
					},
					error: function() 
					{
					
					}
				}
			);
		});
	
	});
</script>
{% endblock %}