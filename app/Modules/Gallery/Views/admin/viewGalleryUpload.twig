{% extends 'base.twig' %}

{% block content %}
<div class="container mt-4">
  <h1 class="h3 mb-4"><i class="fas fa-upload me-2"></i> Ajouter une image</h1>

  <form id="form-upload" enctype="multipart/form-data">
    <div class="mb-3">
      <label class="form-label">Titre</label>
      <input type="text" name="title" class="form-control" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Description</label>
      <textarea name="description" class="form-control"></textarea>
    </div>

    <div class="row g-3">
      <div class="col-sm-6">
        <label class="form-label">Catégorie existante</label>
        <select name="category_id" class="form-select">
          <option value="">— Aucune / Non classée —</option>
          {% for c in categories %}
            {# c.ID, c.NAME supposés par ton Manager/Entity #}
            <option value="{{ c.getID ? c.getID() : c.ID }}">
              {{ c.getNAME ? c.getNAME() : c.NAME }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-sm-6">
        <label class="form-label">… ou créer une nouvelle</label>
        <input type="text" name="category" class="form-control" placeholder="Nom de la nouvelle catégorie">
        <div class="form-text">
          Si vous choisissez une catégorie existante, ce champ sera ignoré.
        </div>
      </div>
    </div>

    <div class="mb-3 mt-3">
      <label class="form-label">Fichier image</label>
      <input type="file" name="image" accept="image/*" class="form-control" required>
    </div>

    <button type="submit" class="btn btn-success">
      <i class="fas fa-save"></i> Enregistrer
    </button>
    <a href="{{ base_url }}/admin/gallery" class="btn btn-secondary">Annuler</a>
  </form>
</div>
{% endblock %}

{% block jquery %}
<script>
$('#form-upload').on('submit', function(e){
  e.preventDefault();

  const form = this;
  const formData = new FormData(form);
  formData.append('_csrf', '{{ csrf_token }}');

  // Règle: si category_id est rempli, on ignore "category" (création)
  const catId = formData.get('category_id');
  if (catId && String(catId).trim() !== '') {
    formData.set('category', '');
  }

  $.ajax({
    url: '{{ base_url }}/gallery/ajax/upload',
    method: 'POST',
    data: formData,
    contentType: false,
    processData: false,
    dataType: 'json'
  })
  .done(function(resp){
    if (resp && resp.ok) 
    {
      window.location.href = '{{ base_url }}/admin/gallery';
    } 
    else 
    {
      alert('Erreur: ' + (resp && resp.error ? resp.error : 'Inconnue'));
    }
  })
  .fail(function(xhr){
    let msg = 'Erreur réseau';
    if (xhr && xhr.responseText) {
      try { const j = JSON.parse(xhr.responseText); msg = j.error || msg; } catch(_){}
    }
    alert('Erreur: ' + msg);
  });
});
</script>
{% endblock %}
